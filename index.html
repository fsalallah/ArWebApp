<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>AR Placement Lab</title>
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <style>
      #overlay {
        position: fixed;
        top: 20px;
        left: 0;
        width: 100%;
        z-index: 1000;
        pointer-events: none;
        font-family: sans-serif;
        display: none; /* Hidden until AR starts */
      }
      .msg-box {
        width: 80%;
        margin: 0 auto;
        background: rgba(0,0,0,0.7);
        color: white;
        padding: 15px;
        border-radius: 10px;
        text-align: center;
      }
      /* Custom Start Button if the default one is hidden */
      #start-btn {
        position: fixed;
        bottom: 50px;
        left: 50%;
        transform: translateX(-50%);
        padding: 15px 30px;
        background: #4CC3D9;
        color: white;
        border: none;
        border-radius: 30px;
        font-weight: bold;
        z-index: 2000;
      }
    </style>
  </head>
  <body>

    <!-- This button helps if the default AR button is hard to see -->
    <button id="start-btn">ENTER AR MODE</button>

    <div id="overlay">
      <div class="msg-box" id="instructions">
        Slowly move your phone to scan the floor...
      </div>
    </div>

    <a-scene 
      webxr="requiredFeatures: hit-test, local-floor; optionalFeatures: dom-overlay; overlayElement: #overlay;"
      renderer="alpha: true; antialias: true;">
      
      <a-light type="ambient" intensity="0.6"></a-light>
      <a-light type="directional" position="1 2 1" intensity="0.8"></a-light>

      <!-- The Reticle (Floor Marker) -->
      <a-entity id="reticle" ar-hit-test="target: #reticle; type: footprint;" visible="false">
        <a-ring rotation="-90 0 0" radius-inner="0.06" radius-outer="0.1" color="#00FF00" line-width="2"></a-ring>
        <a-circle rotation="-90 0 0" radius="0.02" color="#00FF00"></a-circle>
      </a-entity>

      <!-- The Box to be placed -->
      <a-box id="placed-object" 
             visible="false" 
             scale="0.2 0.2 0.2" 
             material="color: #FF9500; metalness: 0.4; roughness: 0.3;">
      </a-box>

      <a-entity camera></a-entity>
    </a-scene>

    <script>
      const scene = document.querySelector('a-scene');
      const startBtn = document.getElementById('start-btn');
      const reticle = document.getElementById('reticle');
      const object = document.getElementById('placed-object');
      const instructions = document.getElementById('instructions');
      const overlay = document.getElementById('overlay');

      // 1. Manually trigger AR mode when button is clicked
      startBtn.addEventListener('click', () => {
        scene.enterVR(); // This triggers the AR request
      });

      // 2. When AR starts
      scene.addEventListener('enter-vr', () => {
        if (scene.is('ar-mode')) {
          startBtn.style.display = 'none'; // Hide start button
          overlay.style.display = 'block'; // Show instructions
        }
      });

      // 3. Detect when the floor is found
      // We check every frame if the reticle is visible
      setInterval(() => {
        if (scene.is('ar-mode')) {
          if (reticle.getAttribute('visible') === true) {
            instructions.innerHTML = "Floor Detected!<br>Tap screen to place box.";
            instructions.style.background = "rgba(0, 150, 0, 0.7)";
          } else {
            instructions.innerHTML = "Scanning for floor...<br>Try pointing at a rug or textured surface.";
            instructions.style.background = "rgba(0, 0, 0, 0.7)";
          }
        }
      }, 500);

      // 4. Placement Logic
      scene.addEventListener('click', () => {
        if (reticle.getAttribute('visible') === true) {
          const pos = reticle.getAttribute('position');
          object.setAttribute('position', pos);
          object.setAttribute('visible', 'true');
          
          // Animation effect
          object.setAttribute('animation', {
            property: 'scale',
            from: '0 0 0',
            to: '0.2 0.2 0.2',
            dur: 300
          });
        }
      });
    </script>
  </body>
</html>
