<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Honor Deep Diagnostic</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-black text-white">
    <div id="ui" class="p-6">
        <h1 class="text-xl font-bold mb-4">WebXR Deep Scan</h1>
        <button id="run" class="w-full bg-blue-600 py-4 rounded-xl font-bold mb-4">RUN DIAGNOSTIC</button>
        <div id="log" class="font-mono text-xs bg-gray-900 p-4 rounded-lg border border-gray-700 h-96 overflow-y-auto">
            > Tap button to start...
        </div>
    </div>

    <script>
        const logEl = document.getElementById('log');
        function log(msg, color = "text-gray-400") {
            logEl.innerHTML += `<div class="${color}">> ${msg}</div>`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        document.getElementById('run').onclick = async () => {
            log("Starting Scan...", "text-white");

            if (!navigator.xr) {
                log("FAIL: WebXR not found in navigator", "text-red-500");
                return;
            }

            try {
                // We request ALL features to force the driver to wake up
                const session = await navigator.xr.requestSession('immersive-ar', {
                    requiredFeatures: ['local'],
                    optionalFeatures: ['viewer', 'local-floor', 'unbounded', 'dom-overlay'],
                    domOverlay: { root: document.body }
                });

                log("SESSION: Granted", "text-green-500");

                const spaces = ['local', 'viewer', 'local-floor', 'unbounded'];
                
                for (const space of spaces) {
                    try {
                        log(`Testing Space: ${space}...`);
                        const refSpace = await session.requestReferenceSpace(space);
                        log(`SUCCESS: ${space} is supported!`, "text-blue-400");
                        
                        // If one works, we try to start the loop
                        startAR(session, refSpace);
                        return; 
                    } catch (e) {
                        log(`FAIL: ${space} (${e.name})`, "text-red-400");
                    }
                }

                log("RESULT: No reference spaces supported.", "text-red-600");
                log("This usually means ARCore is not set as the default AR provider.", "text-yellow-500");

            } catch (e) {
                log("SESSION ERROR: " + e.message, "text-red-500");
            }
        };

        function startAR(session, refSpace) {
            log("Attempting to start renderer...", "text-green-500");
            const renderer = new THREE.WebGLRenderer({ alpha: true });
            renderer.xr.enabled = true;
            renderer.xr.setSession(session);
            
            document.getElementById('ui').style.display = 'none';
            
            renderer.setAnimationLoop(() => {
                renderer.render(new THREE.Scene(), new THREE.PerspectiveCamera());
            });
        }
    </script>
</body>
</html>
